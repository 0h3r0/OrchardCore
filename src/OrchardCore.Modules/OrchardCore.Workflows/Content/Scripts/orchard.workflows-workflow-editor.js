/*
** NOTE: This file is generated by Gulp and should not be edited directly!
** Any changes made directly to this file will be overwritten next time its asset group is processed by Gulp.
*/

///<reference path='../Lib/jquery/typings.d.ts' />
///<reference path='../Lib/jsplumb/typings.d.ts' />
///<reference path='./workflow-models.ts' />
// TODO: Re-implement this using a MVVM approach.
var WorkflowEditor = /** @class */ (function () {
    function WorkflowEditor(container, workflowDefinition, deleteActivityPrompt, localId, loadLocalState) {
        var _this = this;
        this.container = container;
        this.workflowDefinition = workflowDefinition;
        this.deleteActivityPrompt = deleteActivityPrompt;
        this.localId = localId;
        this.minCanvasHeight = 400;
        this.getActivity = function (id, activities) {
            if (activities === void 0) { activities = null; }
            if (!activities) {
                activities = this.workflowDefinition.activities;
            }
            return $.grep(activities, function (x) { return x.id === id; })[0];
        };
        this.getState = function () {
            var $allActivityElements = $(this.container).find('.activity');
            var workflow = {
                id: this.workflowDefinition.id,
                activities: [],
                transitions: [],
                removedActivities: this.workflowDefinition.removedActivities
            };
            // Collect activities.
            for (var i = 0; i < $allActivityElements.length; i++) {
                var $activityElement = $($allActivityElements[i]);
                var activityId = $activityElement.data('activity-id');
                var activityIsStart = $activityElement.data('activity-start');
                var activityPosition = $activityElement.position();
                var activity = this.getActivity(activityId);
                workflow.activities.push({
                    id: activityId,
                    isStart: activityIsStart,
                    outcomes: activity.outcomes,
                    x: activityPosition.left,
                    y: activityPosition.top
                });
            }
            // Collect connections.
            var allConnections = this.jsPlumbInstance.getConnections();
            for (var i = 0; i < allConnections.length; i++) {
                var connection = allConnections[i];
                var sourceEndpoint = connection.endpoints[0];
                var sourceOutcomeName = sourceEndpoint.getParameters().outcome.name;
                var sourceActivityId = $(connection.source).data('activity-id');
                var destinationActivityId = $(connection.target).data('activity-id');
                workflow.transitions.push({
                    sourceActivityId: sourceActivityId,
                    destinationActivityId: destinationActivityId,
                    sourceOutcomeName: sourceOutcomeName
                });
            }
            return workflow;
        };
        this.serialize = function () {
            var workflow = this.getState();
            return JSON.stringify(workflow);
        };
        this.saveLocalState = function () {
            var workflow = this.getState();
            sessionStorage[this.localId] = this.serialize(workflow);
        };
        this.loadLocalState = function () {
            return JSON.parse(sessionStorage[this.localId]);
        };
        this.updateCanvasHeight = function () {
            var $container = $(this.container);
            // Get the activity element with the highest Y coordinate.
            var $activityElements = $container.find(".activity");
            var currentElementTop = 0;
            var currentActivityHeight = 0;
            for (var _i = 0, _a = $activityElements.toArray(); _i < _a.length; _i++) {
                var activityElement = _a[_i];
                var $activityElement = $(activityElement);
                var top_1 = $activityElement.position().top;
                if (top_1 > currentElementTop) {
                    currentElementTop = top_1;
                    currentActivityHeight = $activityElement.height();
                }
            }
            var newCanvasHeight = currentElementTop + currentActivityHeight;
            var elementBottom = currentElementTop + currentActivityHeight;
            var stretchValue = 100;
            if (newCanvasHeight - elementBottom <= stretchValue) {
                newCanvasHeight += stretchValue;
            }
            $container.height(Math.max(this.minCanvasHeight, newCanvasHeight));
        };
        var self = this;
        jsPlumb.ready(function () {
            jsPlumb.importDefaults({
                Anchor: "Continuous",
                DragOptions: { cursor: 'pointer', zIndex: 2000 },
                EndpointStyles: [{ fillStyle: '#225588' }],
                Endpoints: [["Dot", { radius: 7 }], ["Blank"]],
                ConnectionOverlays: [
                    ["Arrow", { width: 12, length: 12, location: -5 }],
                ],
                ConnectorZIndex: 5
            });
            var plumber = jsPlumb.getInstance({
                DragOptions: { cursor: 'pointer', zIndex: 2000 },
                ConnectionOverlays: [
                    ['Arrow', {
                            location: 1,
                            visible: true,
                            width: 11,
                            length: 11
                        }],
                    ['Label', {
                            location: 0.5,
                            id: 'label',
                            cssClass: 'connection-label'
                        }]
                ],
                Container: container
            });
            var getSourceEndpointOptions = function (activity, outcome) {
                // The definition of source endpoints.
                return {
                    endpoint: 'Dot',
                    anchor: 'Continuous',
                    paintStyle: {
                        stroke: '#7AB02C',
                        fill: '#7AB02C',
                        radius: 7,
                        strokeWidth: 1
                    },
                    isSource: true,
                    connector: ['Flowchart', { stub: [40, 60], gap: 0, cornerRadius: 5, alwaysRespectStubs: true }],
                    connectorStyle: {
                        strokeWidth: 2,
                        stroke: '#999999',
                        joinstyle: 'round',
                        outlineStroke: 'white',
                        outlineWidth: 2
                    },
                    hoverPaintStyle: {
                        fill: '#216477',
                        stroke: '#216477'
                    },
                    connectorHoverStyle: {
                        strokeWidth: 3,
                        stroke: '#216477',
                        outlineWidth: 5,
                        outlineStroke: 'white'
                    },
                    connectorOverlays: [['Label', { location: [3, -1.5], cssClass: 'endpointSourceLabel' }]],
                    dragOptions: {},
                    uuid: activity.id + "-" + outcome.name,
                    parameters: {
                        outcome: outcome
                    }
                };
            };
            // Listen for new connections.
            plumber.bind('connection', function (connInfo, originalEvent) {
                var connection = connInfo.connection;
                var outcome = connection.getParameters().outcome;
                var label = connection.getOverlay('label');
                label.setLabel(outcome.displayName);
            });
            var activityElements = $(container).find('.activity');
            var areEqualOutcomes = function (outcomes1, outcomes2) {
                if (outcomes1.length != outcomes2.length) {
                    return false;
                }
                for (var i = 0; i < outcomes1.length; i++) {
                    var outcome1 = outcomes1[i];
                    var outcome2 = outcomes2[i];
                    if (outcome1.name != outcome2.displayName || outcome1.displayName != outcome2.displayName) {
                        return false;
                    }
                }
                return true;
            };
            // Suspend drawing and initialize.
            plumber.batch(function () {
                var serverWorkflowDefinition = _this.workflowDefinition;
                var workflowId = _this.workflowDefinition.id;
                if (loadLocalState) {
                    var localState = _this.loadLocalState();
                    if (localState) {
                        _this.workflowDefinition = localState;
                    }
                }
                activityElements.each(function (index, activityElement) {
                    var $activityElement = $(activityElement);
                    var activityId = $activityElement.data('activity-id');
                    var isDeleted = _this.workflowDefinition.removedActivities.indexOf(activityId) > -1;
                    if (isDeleted) {
                        $activityElement.remove();
                        return;
                    }
                    var activity = _this.getActivity(activityId);
                    var serverActivity = _this.getActivity(activityId, serverWorkflowDefinition.activities);
                    // Update the activity's visual state.
                    if (loadLocalState) {
                        if (activity == null) {
                            // This is a newly added activity not yet added to local state.
                            activity = serverActivity;
                            _this.workflowDefinition.activities.push(activity);
                            activity.x = 50;
                            activity.y = 50;
                        }
                        else {
                            // The available outcomes might have changed when editing an activity,
                            // so we need to check for that and update the client's activity outcomes if so.
                            var sameOutcomes = areEqualOutcomes(activity.outcomes, serverActivity.outcomes);
                            if (!sameOutcomes) {
                                activity.outcomes = serverActivity.outcomes;
                            }
                            $activityElement
                                .css({ left: activity.x, top: activity.y })
                                .toggleClass('activity-start', activity.isStart)
                                .data('activity-start', activity.isStart);
                        }
                    }
                    // Make the activity draggable.
                    plumber.draggable(activityElement, {
                        grid: [10, 10],
                        containment: true,
                        start: function (args) {
                            _this.dragStart = { left: args.e.screenX, top: args.e.screenY };
                        },
                        stop: function (args) {
                            _this.hasDragged = _this.dragStart.left != args.e.screenX || _this.dragStart.top != args.e.screenY;
                            _this.updateCanvasHeight();
                        }
                    });
                    // Configure the activity as a target.
                    plumber.makeTarget(activityElement, {
                        dropOptions: { hoverClass: 'hover' },
                        anchor: 'Continuous',
                        endpoint: ['Blank', { radius: 8 }]
                    });
                    // Add source endpoints.
                    for (var _i = 0, _a = activity.outcomes; _i < _a.length; _i++) {
                        var outcome = _a[_i];
                        var sourceEndpointOptions = getSourceEndpointOptions(activity, outcome);
                        plumber.addEndpoint(activityElement, { connectorOverlays: [['Label', { label: outcome.displayName, cssClass: 'connection-label' }]] }, sourceEndpointOptions);
                    }
                });
                // Connect activities.
                for (var _i = 0, _a = _this.workflowDefinition.transitions; _i < _a.length; _i++) {
                    var transitionModel = _a[_i];
                    var sourceEndpointUuid = transitionModel.sourceActivityId + "-" + transitionModel.sourceOutcomeName;
                    var sourceEndpoint = plumber.getEndpoint(sourceEndpointUuid);
                    var destinationElementId = "activity-" + workflowId + "-" + transitionModel.destinationActivityId;
                    plumber.connect({
                        source: sourceEndpoint,
                        target: destinationElementId
                    });
                }
                // Re-query the activity elements.
                activityElements = $(container).find('.activity');
                // Make all activity elements visible.
                activityElements.show();
                plumber.bind('contextmenu', function (component, originalEvent) {
                });
                plumber.bind('connectionDrag', function (connection) {
                    console.log('connection ' + connection.id + ' is being dragged. suspendedElement is ', connection.suspendedElement, ' of type ', connection.suspendedElementType);
                });
                plumber.bind('connectionDragStop', function (connection) {
                    console.log('connection ' + connection.id + ' was dragged');
                });
                plumber.bind('connectionMoved', function (params) {
                    console.log('connection ' + params.connection.id + ' was moved');
                });
                _this.updateCanvasHeight();
            });
            // Initialize popovers.
            activityElements.popover({
                trigger: 'manual',
                html: true,
                content: function () {
                    var activityElement = $(this);
                    var $content = activityElement.find('.activity-commands').clone().show();
                    var startButton = $content.find('.activity-start-action');
                    var isStart = activityElement.data('activity-start') === true;
                    var activityId = activityElement.data('activity-id');
                    startButton.attr('aria-pressed', activityElement.data('activity-start'));
                    startButton.toggleClass('active', isStart);
                    $content.on('click', '.activity-start-action', function (e) {
                        e.preventDefault();
                        var button = $(e.currentTarget);
                        button.button('toggle');
                        var isStart = button.is('.active');
                        activityElement.data('activity-start', isStart);
                        activityElement.toggleClass('activity-start', isStart);
                    });
                    $content.on('click', '.activity-delete-action', function (e) {
                        e.preventDefault();
                        if (!confirm(self.deleteActivityPrompt)) {
                            return;
                        }
                        self.workflowDefinition.removedActivities.push(activityId);
                        plumber.remove(activityElement);
                        activityElement.popover('dispose');
                    });
                    $content.on('click', '[data-persist-workflow]', function (e) {
                        self.saveLocalState();
                    });
                    return $content.get(0);
                }
            });
            $(container).on('click', '.activity', function (e) {
                if (_this.hasDragged) {
                    _this.hasDragged = false;
                    return;
                }
                // if any other popovers are visible, hide them
                if (_this.isPopoverVisible) {
                    activityElements.popover('hide');
                }
                var sender = $(e.currentTarget);
                sender.popover('show');
                // handle clicking on the popover itself.
                $('.popover').off('click').on('click', function (e2) {
                    e2.stopPropagation();
                });
                e.stopPropagation();
                _this.isPopoverVisible = true;
            });
            $(container).on('dblclick', '.activity', function (e) {
                var sender = $(e.currentTarget);
                _this.saveLocalState();
                sender.find('.activity-edit-action').get(0).click();
            });
            // Hide all popovers when clicking anywhere but on an activity.
            $('body').on('click', function (e) {
                activityElements.popover('hide');
                _this.isPopoverVisible = false;
            });
            // Save local changes if the event target has the 'data-persist-workflow' attribute.
            $('body').on('click', '[data-persist-workflow]', function (e) {
                _this.saveLocalState();
            });
            _this.jsPlumbInstance = plumber;
        });
    }
    return WorkflowEditor;
}());
$.fn.workflowEditor = function () {
    this.each(function (index, element) {
        var $element = $(element);
        var workflowDefinition = $element.data('workflow-definition');
        var deleteActivityPrompt = $element.data('workflow-delete-activity-prompt');
        var localId = $element.data('workflow-local-id');
        var loadLocalState = $element.data('workflow-load-local-state');
        workflowDefinition.removedActivities = workflowDefinition.removedActivities || [];
        $element.data('workflowEditor', new WorkflowEditor(element, workflowDefinition, deleteActivityPrompt, localId, loadLocalState));
    });
    return this;
};
$(document).ready(function () {
    var workflowEditor = $('.workflow-editor-canvas').workflowEditor().data('workflowEditor');
    $('#workflowEditorForm').on('submit', function (s, e) {
        var state = workflowEditor.serialize();
        $('#workflowStateInput').val(state);
    });
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUM7SUFDZCxJQUFNLGNBQWMsR0FBbUIsQ0FBQyxDQUFDLHlCQUF5QixDQUFDLENBQUMsY0FBYyxFQUFFLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7SUFFNUcsQ0FBQyxDQUFDLHFCQUFxQixDQUFDLENBQUMsRUFBRSxDQUFDLFFBQVEsRUFBRSxVQUFDLENBQUMsRUFBRSxDQUFDO1FBQ3ZDLElBQU0sS0FBSyxHQUFHLGNBQWMsQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUN6QyxDQUFDLENBQUMscUJBQXFCLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDeEMsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUMsQ0FBQyIsImZpbGUiOiJvcmNoYXJkLndvcmtmbG93cy13b3JrZmxvdy1lZGl0b3IuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy88cmVmZXJlbmNlIHBhdGg9Jy4uL0xpYi9qcXVlcnkvdHlwaW5ncy5kLnRzJyAvPlxyXG4vLy88cmVmZXJlbmNlIHBhdGg9Jy4uL0xpYi9qc3BsdW1iL3R5cGluZ3MuZC50cycgLz5cclxuLy8vPHJlZmVyZW5jZSBwYXRoPScuL3dvcmtmbG93LW1vZGVscy50cycgLz5cclxuXHJcbi8vIFRPRE86IFJlLWltcGxlbWVudCB0aGlzIHVzaW5nIGEgTVZWTSBhcHByb2FjaC5cclxuY2xhc3MgV29ya2Zsb3dFZGl0b3Ige1xyXG4gICAgcHJpdmF0ZSBpc1BvcG92ZXJWaXNpYmxlOiBib29sZWFuO1xyXG4gICAgcHJpdmF0ZSBoYXNEcmFnZ2VkOiBib29sZWFuO1xyXG4gICAgcHJpdmF0ZSBkcmFnU3RhcnQ6IEpRdWVyeS5Db29yZGluYXRlcztcclxuICAgIHByaXZhdGUgbWluQ2FudmFzSGVpZ2h0OiBudW1iZXIgPSA0MDA7XHJcbiAgICBwcml2YXRlIGpzUGx1bWJJbnN0YW5jZToganNQbHVtYkluc3RhbmNlO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgY29udGFpbmVyOiBIVE1MRWxlbWVudCwgcHJpdmF0ZSB3b3JrZmxvd0RlZmluaXRpb246IFdvcmtmbG93cy5Xb3JrZmxvdywgcHJpdmF0ZSBkZWxldGVBY3Rpdml0eVByb21wdDogc3RyaW5nLCBwcml2YXRlIGxvY2FsSWQ6IHN0cmluZywgbG9hZExvY2FsU3RhdGU6IGJvb2xlYW4pIHtcclxuICAgICAgICBjb25zdCBzZWxmID0gdGhpcztcclxuXHJcbiAgICAgICAganNQbHVtYi5yZWFkeSgoKSA9PiB7XHJcbiAgICAgICAgICAgIGpzUGx1bWIuaW1wb3J0RGVmYXVsdHMoe1xyXG4gICAgICAgICAgICAgICAgQW5jaG9yOiBcIkNvbnRpbnVvdXNcIixcclxuICAgICAgICAgICAgICAgIERyYWdPcHRpb25zOiB7IGN1cnNvcjogJ3BvaW50ZXInLCB6SW5kZXg6IDIwMDAgfSxcclxuICAgICAgICAgICAgICAgIEVuZHBvaW50U3R5bGVzOiBbeyBmaWxsU3R5bGU6ICcjMjI1NTg4JyB9XSxcclxuICAgICAgICAgICAgICAgIEVuZHBvaW50czogW1tcIkRvdFwiLCB7IHJhZGl1czogNyB9XSwgW1wiQmxhbmtcIl1dLFxyXG4gICAgICAgICAgICAgICAgQ29ubmVjdGlvbk92ZXJsYXlzOiBbXHJcbiAgICAgICAgICAgICAgICAgICAgW1wiQXJyb3dcIiwgeyB3aWR0aDogMTIsIGxlbmd0aDogMTIsIGxvY2F0aW9uOiAtNSB9XSxcclxuICAgICAgICAgICAgICAgIF0sXHJcbiAgICAgICAgICAgICAgICBDb25uZWN0b3JaSW5kZXg6IDVcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICB2YXIgcGx1bWJlciA9IGpzUGx1bWIuZ2V0SW5zdGFuY2Uoe1xyXG4gICAgICAgICAgICAgICAgRHJhZ09wdGlvbnM6IHsgY3Vyc29yOiAncG9pbnRlcicsIHpJbmRleDogMjAwMCB9LFxyXG4gICAgICAgICAgICAgICAgQ29ubmVjdGlvbk92ZXJsYXlzOiBbXHJcbiAgICAgICAgICAgICAgICAgICAgWydBcnJvdycsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9jYXRpb246IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZpc2libGU6IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiAxMSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGVuZ3RoOiAxMVxyXG4gICAgICAgICAgICAgICAgICAgIH1dLFxyXG4gICAgICAgICAgICAgICAgICAgIFsnTGFiZWwnLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uOiAwLjUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiAnbGFiZWwnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjc3NDbGFzczogJ2Nvbm5lY3Rpb24tbGFiZWwnXHJcbiAgICAgICAgICAgICAgICAgICAgfV1cclxuICAgICAgICAgICAgICAgIF0sXHJcbiAgICAgICAgICAgICAgICBDb250YWluZXI6IGNvbnRhaW5lclxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHZhciBnZXRTb3VyY2VFbmRwb2ludE9wdGlvbnMgPSBmdW5jdGlvbiAoYWN0aXZpdHk6IFdvcmtmbG93cy5BY3Rpdml0eSwgb3V0Y29tZTogV29ya2Zsb3dzLk91dGNvbWUpOiBFbmRwb2ludE9wdGlvbnMge1xyXG4gICAgICAgICAgICAgICAgLy8gVGhlIGRlZmluaXRpb24gb2Ygc291cmNlIGVuZHBvaW50cy5cclxuICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgZW5kcG9pbnQ6ICdEb3QnLFxyXG4gICAgICAgICAgICAgICAgICAgIGFuY2hvcjogJ0NvbnRpbnVvdXMnLFxyXG4gICAgICAgICAgICAgICAgICAgIHBhaW50U3R5bGU6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3Ryb2tlOiAnIzdBQjAyQycsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGw6ICcjN0FCMDJDJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmFkaXVzOiA3LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdHJva2VXaWR0aDogMVxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgaXNTb3VyY2U6IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdG9yOiBbJ0Zsb3djaGFydCcsIHsgc3R1YjogWzQwLCA2MF0sIGdhcDogMCwgY29ybmVyUmFkaXVzOiA1LCBhbHdheXNSZXNwZWN0U3R1YnM6IHRydWUgfV0sXHJcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdG9yU3R5bGU6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3Ryb2tlV2lkdGg6IDIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0cm9rZTogJyM5OTk5OTknLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBqb2luc3R5bGU6ICdyb3VuZCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG91dGxpbmVTdHJva2U6ICd3aGl0ZScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG91dGxpbmVXaWR0aDogMlxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgaG92ZXJQYWludFN0eWxlOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGw6ICcjMjE2NDc3JyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3Ryb2tlOiAnIzIxNjQ3NydcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3RvckhvdmVyU3R5bGU6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3Ryb2tlV2lkdGg6IDMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0cm9rZTogJyMyMTY0NzcnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBvdXRsaW5lV2lkdGg6IDUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG91dGxpbmVTdHJva2U6ICd3aGl0ZSdcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3Rvck92ZXJsYXlzOiBbWydMYWJlbCcsIHsgbG9jYXRpb246IFszLCAtMS41XSwgY3NzQ2xhc3M6ICdlbmRwb2ludFNvdXJjZUxhYmVsJyB9XV0sXHJcbiAgICAgICAgICAgICAgICAgICAgZHJhZ09wdGlvbnM6IHt9LFxyXG4gICAgICAgICAgICAgICAgICAgIHV1aWQ6IGAke2FjdGl2aXR5LmlkfS0ke291dGNvbWUubmFtZX1gLFxyXG4gICAgICAgICAgICAgICAgICAgIHBhcmFtZXRlcnM6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgb3V0Y29tZTogb3V0Y29tZVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAvLyBMaXN0ZW4gZm9yIG5ldyBjb25uZWN0aW9ucy5cclxuICAgICAgICAgICAgcGx1bWJlci5iaW5kKCdjb25uZWN0aW9uJywgZnVuY3Rpb24gKGNvbm5JbmZvLCBvcmlnaW5hbEV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjb25uZWN0aW9uOiBDb25uZWN0aW9uID0gY29ubkluZm8uY29ubmVjdGlvbjtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG91dGNvbWU6IFdvcmtmbG93cy5PdXRjb21lID0gY29ubmVjdGlvbi5nZXRQYXJhbWV0ZXJzKCkub3V0Y29tZTtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBsYWJlbDogYW55ID0gY29ubmVjdGlvbi5nZXRPdmVybGF5KCdsYWJlbCcpO1xyXG4gICAgICAgICAgICAgICAgbGFiZWwuc2V0TGFiZWwob3V0Y29tZS5kaXNwbGF5TmFtZSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgbGV0IGFjdGl2aXR5RWxlbWVudHMgPSAkKGNvbnRhaW5lcikuZmluZCgnLmFjdGl2aXR5Jyk7XHJcblxyXG4gICAgICAgICAgICB2YXIgYXJlRXF1YWxPdXRjb21lcyA9IGZ1bmN0aW9uIChvdXRjb21lczE6IFdvcmtmbG93cy5PdXRjb21lW10sIG91dGNvbWVzMjogV29ya2Zsb3dzLk91dGNvbWVbXSk6IGJvb2xlYW4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKG91dGNvbWVzMS5sZW5ndGggIT0gb3V0Y29tZXMyLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG91dGNvbWVzMS5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG91dGNvbWUxID0gb3V0Y29tZXMxW2ldO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG91dGNvbWUyID0gb3V0Y29tZXMyW2ldO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAob3V0Y29tZTEubmFtZSAhPSBvdXRjb21lMi5kaXNwbGF5TmFtZSB8fCBvdXRjb21lMS5kaXNwbGF5TmFtZSAhPSBvdXRjb21lMi5kaXNwbGF5TmFtZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBTdXNwZW5kIGRyYXdpbmcgYW5kIGluaXRpYWxpemUuXHJcbiAgICAgICAgICAgIHBsdW1iZXIuYmF0Y2goKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdmFyIHNlcnZlcldvcmtmbG93RGVmaW5pdGlvbjogV29ya2Zsb3dzLldvcmtmbG93ID0gdGhpcy53b3JrZmxvd0RlZmluaXRpb247XHJcbiAgICAgICAgICAgICAgICB2YXIgd29ya2Zsb3dJZDogbnVtYmVyID0gdGhpcy53b3JrZmxvd0RlZmluaXRpb24uaWQ7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKGxvYWRMb2NhbFN0YXRlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbG9jYWxTdGF0ZTogV29ya2Zsb3dzLldvcmtmbG93ID0gdGhpcy5sb2FkTG9jYWxTdGF0ZSgpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAobG9jYWxTdGF0ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLndvcmtmbG93RGVmaW5pdGlvbiA9IGxvY2FsU3RhdGU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGFjdGl2aXR5RWxlbWVudHMuZWFjaCgoaW5kZXgsIGFjdGl2aXR5RWxlbWVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0ICRhY3Rpdml0eUVsZW1lbnQgPSAkKGFjdGl2aXR5RWxlbWVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWN0aXZpdHlJZCA9ICRhY3Rpdml0eUVsZW1lbnQuZGF0YSgnYWN0aXZpdHktaWQnKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBpc0RlbGV0ZWQgPSB0aGlzLndvcmtmbG93RGVmaW5pdGlvbi5yZW1vdmVkQWN0aXZpdGllcy5pbmRleE9mKGFjdGl2aXR5SWQpID4gLTE7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpc0RlbGV0ZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGl2aXR5RWxlbWVudC5yZW1vdmUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGFjdGl2aXR5ID0gdGhpcy5nZXRBY3Rpdml0eShhY3Rpdml0eUlkKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBzZXJ2ZXJBY3Rpdml0eSA9IHRoaXMuZ2V0QWN0aXZpdHkoYWN0aXZpdHlJZCwgc2VydmVyV29ya2Zsb3dEZWZpbml0aW9uLmFjdGl2aXRpZXMpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAvLyBVcGRhdGUgdGhlIGFjdGl2aXR5J3MgdmlzdWFsIHN0YXRlLlxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChsb2FkTG9jYWxTdGF0ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWN0aXZpdHkgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBpcyBhIG5ld2x5IGFkZGVkIGFjdGl2aXR5IG5vdCB5ZXQgYWRkZWQgdG8gbG9jYWwgc3RhdGUuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3Rpdml0eSA9IHNlcnZlckFjdGl2aXR5O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy53b3JrZmxvd0RlZmluaXRpb24uYWN0aXZpdGllcy5wdXNoKGFjdGl2aXR5KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3Rpdml0eS54ID0gNTA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3Rpdml0eS55ID0gNTA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGUgYXZhaWxhYmxlIG91dGNvbWVzIG1pZ2h0IGhhdmUgY2hhbmdlZCB3aGVuIGVkaXRpbmcgYW4gYWN0aXZpdHksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzbyB3ZSBuZWVkIHRvIGNoZWNrIGZvciB0aGF0IGFuZCB1cGRhdGUgdGhlIGNsaWVudCdzIGFjdGl2aXR5IG91dGNvbWVzIGlmIHNvLlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2FtZU91dGNvbWVzID0gYXJlRXF1YWxPdXRjb21lcyhhY3Rpdml0eS5vdXRjb21lcywgc2VydmVyQWN0aXZpdHkub3V0Y29tZXMpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc2FtZU91dGNvbWVzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZpdHkub3V0Y29tZXMgPSBzZXJ2ZXJBY3Rpdml0eS5vdXRjb21lcztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aXZpdHlFbGVtZW50XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmNzcyh7IGxlZnQ6IGFjdGl2aXR5LngsIHRvcDogYWN0aXZpdHkueSB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50b2dnbGVDbGFzcygnYWN0aXZpdHktc3RhcnQnLCBhY3Rpdml0eS5pc1N0YXJ0KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5kYXRhKCdhY3Rpdml0eS1zdGFydCcsIGFjdGl2aXR5LmlzU3RhcnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAvLyBNYWtlIHRoZSBhY3Rpdml0eSBkcmFnZ2FibGUuXHJcbiAgICAgICAgICAgICAgICAgICAgcGx1bWJlci5kcmFnZ2FibGUoYWN0aXZpdHlFbGVtZW50LCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGdyaWQ6IFsxMCwgMTBdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250YWlubWVudDogdHJ1ZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IChhcmdzOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZHJhZ1N0YXJ0ID0geyBsZWZ0OiBhcmdzLmUuc2NyZWVuWCwgdG9wOiBhcmdzLmUuc2NyZWVuWSB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdG9wOiAoYXJnczogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhhc0RyYWdnZWQgPSB0aGlzLmRyYWdTdGFydC5sZWZ0ICE9IGFyZ3MuZS5zY3JlZW5YIHx8IHRoaXMuZHJhZ1N0YXJ0LnRvcCAhPSBhcmdzLmUuc2NyZWVuWTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlQ2FudmFzSGVpZ2h0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gQ29uZmlndXJlIHRoZSBhY3Rpdml0eSBhcyBhIHRhcmdldC5cclxuICAgICAgICAgICAgICAgICAgICBwbHVtYmVyLm1ha2VUYXJnZXQoYWN0aXZpdHlFbGVtZW50LCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRyb3BPcHRpb25zOiB7IGhvdmVyQ2xhc3M6ICdob3ZlcicgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgYW5jaG9yOiAnQ29udGludW91cycsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVuZHBvaW50OiBbJ0JsYW5rJywgeyByYWRpdXM6IDggfV1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gQWRkIHNvdXJjZSBlbmRwb2ludHMuXHJcbiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgb3V0Y29tZSBvZiBhY3Rpdml0eS5vdXRjb21lcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzb3VyY2VFbmRwb2ludE9wdGlvbnMgPSBnZXRTb3VyY2VFbmRwb2ludE9wdGlvbnMoYWN0aXZpdHksIG91dGNvbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwbHVtYmVyLmFkZEVuZHBvaW50KGFjdGl2aXR5RWxlbWVudCwgeyBjb25uZWN0b3JPdmVybGF5czogW1snTGFiZWwnLCB7IGxhYmVsOiBvdXRjb21lLmRpc3BsYXlOYW1lLCBjc3NDbGFzczogJ2Nvbm5lY3Rpb24tbGFiZWwnIH1dXSB9LCBzb3VyY2VFbmRwb2ludE9wdGlvbnMpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIENvbm5lY3QgYWN0aXZpdGllcy5cclxuICAgICAgICAgICAgICAgIGZvciAobGV0IHRyYW5zaXRpb25Nb2RlbCBvZiB0aGlzLndvcmtmbG93RGVmaW5pdGlvbi50cmFuc2l0aW9ucykge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNvdXJjZUVuZHBvaW50VXVpZDogc3RyaW5nID0gYCR7dHJhbnNpdGlvbk1vZGVsLnNvdXJjZUFjdGl2aXR5SWR9LSR7dHJhbnNpdGlvbk1vZGVsLnNvdXJjZU91dGNvbWVOYW1lfWA7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc291cmNlRW5kcG9pbnQ6IEVuZHBvaW50ID0gcGx1bWJlci5nZXRFbmRwb2ludChzb3VyY2VFbmRwb2ludFV1aWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRlc3RpbmF0aW9uRWxlbWVudElkOiBzdHJpbmcgPSBgYWN0aXZpdHktJHt3b3JrZmxvd0lkfS0ke3RyYW5zaXRpb25Nb2RlbC5kZXN0aW5hdGlvbkFjdGl2aXR5SWR9YDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcGx1bWJlci5jb25uZWN0KHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlOiBzb3VyY2VFbmRwb2ludCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiBkZXN0aW5hdGlvbkVsZW1lbnRJZFxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIC8vIFJlLXF1ZXJ5IHRoZSBhY3Rpdml0eSBlbGVtZW50cy5cclxuICAgICAgICAgICAgICAgIGFjdGl2aXR5RWxlbWVudHMgPSAkKGNvbnRhaW5lcikuZmluZCgnLmFjdGl2aXR5Jyk7XHJcblxyXG4gICAgICAgICAgICAgICAgLy8gTWFrZSBhbGwgYWN0aXZpdHkgZWxlbWVudHMgdmlzaWJsZS5cclxuICAgICAgICAgICAgICAgIGFjdGl2aXR5RWxlbWVudHMuc2hvdygpO1xyXG5cclxuICAgICAgICAgICAgICAgIHBsdW1iZXIuYmluZCgnY29udGV4dG1lbnUnLCBmdW5jdGlvbiAoY29tcG9uZW50LCBvcmlnaW5hbEV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICBwbHVtYmVyLmJpbmQoJ2Nvbm5lY3Rpb25EcmFnJywgZnVuY3Rpb24gKGNvbm5lY3Rpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnY29ubmVjdGlvbiAnICsgY29ubmVjdGlvbi5pZCArICcgaXMgYmVpbmcgZHJhZ2dlZC4gc3VzcGVuZGVkRWxlbWVudCBpcyAnLCBjb25uZWN0aW9uLnN1c3BlbmRlZEVsZW1lbnQsICcgb2YgdHlwZSAnLCBjb25uZWN0aW9uLnN1c3BlbmRlZEVsZW1lbnRUeXBlKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIHBsdW1iZXIuYmluZCgnY29ubmVjdGlvbkRyYWdTdG9wJywgZnVuY3Rpb24gKGNvbm5lY3Rpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnY29ubmVjdGlvbiAnICsgY29ubmVjdGlvbi5pZCArICcgd2FzIGRyYWdnZWQnKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIHBsdW1iZXIuYmluZCgnY29ubmVjdGlvbk1vdmVkJywgZnVuY3Rpb24gKHBhcmFtcykge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdjb25uZWN0aW9uICcgKyBwYXJhbXMuY29ubmVjdGlvbi5pZCArICcgd2FzIG1vdmVkJyk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUNhbnZhc0hlaWdodCgpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgcG9wb3ZlcnMuXHJcbiAgICAgICAgICAgIGFjdGl2aXR5RWxlbWVudHMucG9wb3Zlcih7XHJcbiAgICAgICAgICAgICAgICB0cmlnZ2VyOiAnbWFudWFsJyxcclxuICAgICAgICAgICAgICAgIGh0bWw6IHRydWUsXHJcbiAgICAgICAgICAgICAgICBjb250ZW50OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWN0aXZpdHlFbGVtZW50ID0gJCh0aGlzKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCAkY29udGVudDogSlF1ZXJ5ID0gYWN0aXZpdHlFbGVtZW50LmZpbmQoJy5hY3Rpdml0eS1jb21tYW5kcycpLmNsb25lKCkuc2hvdygpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0QnV0dG9uID0gJGNvbnRlbnQuZmluZCgnLmFjdGl2aXR5LXN0YXJ0LWFjdGlvbicpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzU3RhcnQgPSBhY3Rpdml0eUVsZW1lbnQuZGF0YSgnYWN0aXZpdHktc3RhcnQnKSA9PT0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBhY3Rpdml0eUlkOiBudW1iZXIgPSBhY3Rpdml0eUVsZW1lbnQuZGF0YSgnYWN0aXZpdHktaWQnKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgc3RhcnRCdXR0b24uYXR0cignYXJpYS1wcmVzc2VkJywgYWN0aXZpdHlFbGVtZW50LmRhdGEoJ2FjdGl2aXR5LXN0YXJ0JykpO1xyXG4gICAgICAgICAgICAgICAgICAgIHN0YXJ0QnV0dG9uLnRvZ2dsZUNsYXNzKCdhY3RpdmUnLCBpc1N0YXJ0KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgJGNvbnRlbnQub24oJ2NsaWNrJywgJy5hY3Rpdml0eS1zdGFydC1hY3Rpb24nLCBlID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBidXR0b24gPSAkKGUuY3VycmVudFRhcmdldCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBidXR0b24uYnV0dG9uKCd0b2dnbGUnKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzU3RhcnQgPSBidXR0b24uaXMoJy5hY3RpdmUnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZpdHlFbGVtZW50LmRhdGEoJ2FjdGl2aXR5LXN0YXJ0JywgaXNTdGFydCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2aXR5RWxlbWVudC50b2dnbGVDbGFzcygnYWN0aXZpdHktc3RhcnQnLCBpc1N0YXJ0KTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgJGNvbnRlbnQub24oJ2NsaWNrJywgJy5hY3Rpdml0eS1kZWxldGUtYWN0aW9uJywgZSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFjb25maXJtKHNlbGYuZGVsZXRlQWN0aXZpdHlQcm9tcHQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYud29ya2Zsb3dEZWZpbml0aW9uLnJlbW92ZWRBY3Rpdml0aWVzLnB1c2goYWN0aXZpdHlJZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBsdW1iZXIucmVtb3ZlKGFjdGl2aXR5RWxlbWVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2aXR5RWxlbWVudC5wb3BvdmVyKCdkaXNwb3NlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICRjb250ZW50Lm9uKCdjbGljaycsICdbZGF0YS1wZXJzaXN0LXdvcmtmbG93XScsIGUgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhdmVMb2NhbFN0YXRlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAkY29udGVudC5nZXQoMCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgJChjb250YWluZXIpLm9uKCdjbGljaycsICcuYWN0aXZpdHknLCBlID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNEcmFnZ2VkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5oYXNEcmFnZ2VkID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIC8vIGlmIGFueSBvdGhlciBwb3BvdmVycyBhcmUgdmlzaWJsZSwgaGlkZSB0aGVtXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5pc1BvcG92ZXJWaXNpYmxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYWN0aXZpdHlFbGVtZW50cy5wb3BvdmVyKCdoaWRlJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2VuZGVyID0gJChlLmN1cnJlbnRUYXJnZXQpO1xyXG4gICAgICAgICAgICAgICAgc2VuZGVyLnBvcG92ZXIoJ3Nob3cnKTtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyBoYW5kbGUgY2xpY2tpbmcgb24gdGhlIHBvcG92ZXIgaXRzZWxmLlxyXG4gICAgICAgICAgICAgICAgJCgnLnBvcG92ZXInKS5vZmYoJ2NsaWNrJykub24oJ2NsaWNrJywgZTIgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGUyLnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuXHJcbiAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pc1BvcG92ZXJWaXNpYmxlID0gdHJ1ZTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAkKGNvbnRhaW5lcikub24oJ2RibGNsaWNrJywgJy5hY3Rpdml0eScsIGUgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2VuZGVyID0gJChlLmN1cnJlbnRUYXJnZXQpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zYXZlTG9jYWxTdGF0ZSgpO1xyXG4gICAgICAgICAgICAgICAgc2VuZGVyLmZpbmQoJy5hY3Rpdml0eS1lZGl0LWFjdGlvbicpLmdldCgwKS5jbGljaygpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIC8vIEhpZGUgYWxsIHBvcG92ZXJzIHdoZW4gY2xpY2tpbmcgYW55d2hlcmUgYnV0IG9uIGFuIGFjdGl2aXR5LlxyXG4gICAgICAgICAgICAkKCdib2R5Jykub24oJ2NsaWNrJywgZSA9PiB7XHJcbiAgICAgICAgICAgICAgICBhY3Rpdml0eUVsZW1lbnRzLnBvcG92ZXIoJ2hpZGUnKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuaXNQb3BvdmVyVmlzaWJsZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIC8vIFNhdmUgbG9jYWwgY2hhbmdlcyBpZiB0aGUgZXZlbnQgdGFyZ2V0IGhhcyB0aGUgJ2RhdGEtcGVyc2lzdC13b3JrZmxvdycgYXR0cmlidXRlLlxyXG4gICAgICAgICAgICAkKCdib2R5Jykub24oJ2NsaWNrJywgJ1tkYXRhLXBlcnNpc3Qtd29ya2Zsb3ddJywgZSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNhdmVMb2NhbFN0YXRlKCk7XHJcbiAgICAgICAgICAgIH0pXHJcblxyXG4gICAgICAgICAgICB0aGlzLmpzUGx1bWJJbnN0YW5jZSA9IHBsdW1iZXI7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRBY3Rpdml0eSA9IGZ1bmN0aW9uIChpZDogbnVtYmVyLCBhY3Rpdml0aWVzOiBBcnJheTxXb3JrZmxvd3MuQWN0aXZpdHk+ID0gbnVsbCk6IFdvcmtmbG93cy5BY3Rpdml0eSB7XHJcbiAgICAgICAgaWYgKCFhY3Rpdml0aWVzKSB7XHJcbiAgICAgICAgICAgIGFjdGl2aXRpZXMgPSB0aGlzLndvcmtmbG93RGVmaW5pdGlvbi5hY3Rpdml0aWVzO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gJC5ncmVwKGFjdGl2aXRpZXMsICh4OiBXb3JrZmxvd3MuQWN0aXZpdHkpID0+IHguaWQgPT09IGlkKVswXTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldFN0YXRlID0gZnVuY3Rpb24gKCk6IFdvcmtmbG93cy5Xb3JrZmxvdyB7XHJcbiAgICAgICAgY29uc3QgJGFsbEFjdGl2aXR5RWxlbWVudHMgPSAkKHRoaXMuY29udGFpbmVyKS5maW5kKCcuYWN0aXZpdHknKTtcclxuICAgICAgICBjb25zdCB3b3JrZmxvdzogV29ya2Zsb3dzLldvcmtmbG93ID0ge1xyXG4gICAgICAgICAgICBpZDogdGhpcy53b3JrZmxvd0RlZmluaXRpb24uaWQsXHJcbiAgICAgICAgICAgIGFjdGl2aXRpZXM6IFtdLFxyXG4gICAgICAgICAgICB0cmFuc2l0aW9uczogW10sXHJcbiAgICAgICAgICAgIHJlbW92ZWRBY3Rpdml0aWVzOiB0aGlzLndvcmtmbG93RGVmaW5pdGlvbi5yZW1vdmVkQWN0aXZpdGllc1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8vIENvbGxlY3QgYWN0aXZpdGllcy5cclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8ICRhbGxBY3Rpdml0eUVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGNvbnN0ICRhY3Rpdml0eUVsZW1lbnQ6IEpRdWVyeSA9ICQoJGFsbEFjdGl2aXR5RWxlbWVudHNbaV0pO1xyXG4gICAgICAgICAgICBjb25zdCBhY3Rpdml0eUlkOiBudW1iZXIgPSAkYWN0aXZpdHlFbGVtZW50LmRhdGEoJ2FjdGl2aXR5LWlkJyk7XHJcbiAgICAgICAgICAgIGNvbnN0IGFjdGl2aXR5SXNTdGFydDogYm9vbGVhbiA9ICRhY3Rpdml0eUVsZW1lbnQuZGF0YSgnYWN0aXZpdHktc3RhcnQnKTtcclxuICAgICAgICAgICAgY29uc3QgYWN0aXZpdHlQb3NpdGlvbjogSlF1ZXJ5LkNvb3JkaW5hdGVzID0gJGFjdGl2aXR5RWxlbWVudC5wb3NpdGlvbigpO1xyXG4gICAgICAgICAgICBjb25zdCBhY3Rpdml0eTogV29ya2Zsb3dzLkFjdGl2aXR5ID0gdGhpcy5nZXRBY3Rpdml0eShhY3Rpdml0eUlkKTtcclxuXHJcbiAgICAgICAgICAgIHdvcmtmbG93LmFjdGl2aXRpZXMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICBpZDogYWN0aXZpdHlJZCxcclxuICAgICAgICAgICAgICAgIGlzU3RhcnQ6IGFjdGl2aXR5SXNTdGFydCxcclxuICAgICAgICAgICAgICAgIG91dGNvbWVzOiBhY3Rpdml0eS5vdXRjb21lcyxcclxuICAgICAgICAgICAgICAgIHg6IGFjdGl2aXR5UG9zaXRpb24ubGVmdCxcclxuICAgICAgICAgICAgICAgIHk6IGFjdGl2aXR5UG9zaXRpb24udG9wXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gQ29sbGVjdCBjb25uZWN0aW9ucy5cclxuICAgICAgICBjb25zdCBhbGxDb25uZWN0aW9ucyA9IHRoaXMuanNQbHVtYkluc3RhbmNlLmdldENvbm5lY3Rpb25zKCk7XHJcblxyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYWxsQ29ubmVjdGlvbnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgdmFyIGNvbm5lY3Rpb24gPSBhbGxDb25uZWN0aW9uc1tpXTtcclxuICAgICAgICAgICAgdmFyIHNvdXJjZUVuZHBvaW50OiBFbmRwb2ludCA9IGNvbm5lY3Rpb24uZW5kcG9pbnRzWzBdO1xyXG4gICAgICAgICAgICB2YXIgc291cmNlT3V0Y29tZU5hbWUgPSBzb3VyY2VFbmRwb2ludC5nZXRQYXJhbWV0ZXJzKCkub3V0Y29tZS5uYW1lO1xyXG4gICAgICAgICAgICB2YXIgc291cmNlQWN0aXZpdHlJZDogbnVtYmVyID0gJChjb25uZWN0aW9uLnNvdXJjZSkuZGF0YSgnYWN0aXZpdHktaWQnKTtcclxuICAgICAgICAgICAgdmFyIGRlc3RpbmF0aW9uQWN0aXZpdHlJZDogbnVtYmVyID0gJChjb25uZWN0aW9uLnRhcmdldCkuZGF0YSgnYWN0aXZpdHktaWQnKTtcclxuXHJcbiAgICAgICAgICAgIHdvcmtmbG93LnRyYW5zaXRpb25zLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgc291cmNlQWN0aXZpdHlJZDogc291cmNlQWN0aXZpdHlJZCxcclxuICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uQWN0aXZpdHlJZDogZGVzdGluYXRpb25BY3Rpdml0eUlkLFxyXG4gICAgICAgICAgICAgICAgc291cmNlT3V0Y29tZU5hbWU6IHNvdXJjZU91dGNvbWVOYW1lXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHdvcmtmbG93O1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzZXJpYWxpemUgPSBmdW5jdGlvbiAoKTogc3RyaW5nIHtcclxuICAgICAgICBjb25zdCB3b3JrZmxvdzogV29ya2Zsb3dzLldvcmtmbG93ID0gdGhpcy5nZXRTdGF0ZSgpO1xyXG4gICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh3b3JrZmxvdyk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzYXZlTG9jYWxTdGF0ZSA9IGZ1bmN0aW9uICgpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCB3b3JrZmxvdzogV29ya2Zsb3dzLldvcmtmbG93ID0gdGhpcy5nZXRTdGF0ZSgpO1xyXG4gICAgICAgIHNlc3Npb25TdG9yYWdlW3RoaXMubG9jYWxJZF0gPSB0aGlzLnNlcmlhbGl6ZSh3b3JrZmxvdyk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBsb2FkTG9jYWxTdGF0ZSA9IGZ1bmN0aW9uICgpOiBXb3JrZmxvd3MuV29ya2Zsb3cge1xyXG4gICAgICAgIHJldHVybiBKU09OLnBhcnNlKHNlc3Npb25TdG9yYWdlW3RoaXMubG9jYWxJZF0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgdXBkYXRlQ2FudmFzSGVpZ2h0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGNvbnN0ICRjb250YWluZXIgPSAkKHRoaXMuY29udGFpbmVyKTtcclxuXHJcbiAgICAgICAgLy8gR2V0IHRoZSBhY3Rpdml0eSBlbGVtZW50IHdpdGggdGhlIGhpZ2hlc3QgWSBjb29yZGluYXRlLlxyXG4gICAgICAgIGNvbnN0ICRhY3Rpdml0eUVsZW1lbnRzID0gJGNvbnRhaW5lci5maW5kKFwiLmFjdGl2aXR5XCIpO1xyXG4gICAgICAgIGxldCBjdXJyZW50RWxlbWVudFRvcCA9IDA7XHJcbiAgICAgICAgbGV0IGN1cnJlbnRBY3Rpdml0eUhlaWdodCA9IDA7XHJcblxyXG4gICAgICAgIGZvciAobGV0IGFjdGl2aXR5RWxlbWVudCBvZiAkYWN0aXZpdHlFbGVtZW50cy50b0FycmF5KCkpIHtcclxuICAgICAgICAgICAgY29uc3QgJGFjdGl2aXR5RWxlbWVudCA9ICQoYWN0aXZpdHlFbGVtZW50KTtcclxuICAgICAgICAgICAgY29uc3QgdG9wID0gJGFjdGl2aXR5RWxlbWVudC5wb3NpdGlvbigpLnRvcDtcclxuXHJcbiAgICAgICAgICAgIGlmICh0b3AgPiBjdXJyZW50RWxlbWVudFRvcCkge1xyXG4gICAgICAgICAgICAgICAgY3VycmVudEVsZW1lbnRUb3AgPSB0b3A7XHJcbiAgICAgICAgICAgICAgICBjdXJyZW50QWN0aXZpdHlIZWlnaHQgPSAkYWN0aXZpdHlFbGVtZW50LmhlaWdodCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgbmV3Q2FudmFzSGVpZ2h0ID0gY3VycmVudEVsZW1lbnRUb3AgKyBjdXJyZW50QWN0aXZpdHlIZWlnaHQ7XHJcbiAgICAgICAgY29uc3QgZWxlbWVudEJvdHRvbSA9IGN1cnJlbnRFbGVtZW50VG9wICsgY3VycmVudEFjdGl2aXR5SGVpZ2h0O1xyXG4gICAgICAgIGNvbnN0IHN0cmV0Y2hWYWx1ZSA9IDEwMDtcclxuXHJcbiAgICAgICAgaWYgKG5ld0NhbnZhc0hlaWdodCAtIGVsZW1lbnRCb3R0b20gPD0gc3RyZXRjaFZhbHVlKSB7XHJcbiAgICAgICAgICAgIG5ld0NhbnZhc0hlaWdodCArPSBzdHJldGNoVmFsdWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAkY29udGFpbmVyLmhlaWdodChNYXRoLm1heCh0aGlzLm1pbkNhbnZhc0hlaWdodCwgbmV3Q2FudmFzSGVpZ2h0KSk7XHJcbiAgICB9O1xyXG59XHJcblxyXG4kLmZuLndvcmtmbG93RWRpdG9yID0gZnVuY3Rpb24gKHRoaXM6IEpRdWVyeSk6IEpRdWVyeSB7XHJcbiAgICB0aGlzLmVhY2goKGluZGV4LCBlbGVtZW50KSA9PiB7XHJcbiAgICAgICAgdmFyICRlbGVtZW50ID0gJChlbGVtZW50KTtcclxuICAgICAgICB2YXIgd29ya2Zsb3dEZWZpbml0aW9uOiBXb3JrZmxvd3MuV29ya2Zsb3cgPSAkZWxlbWVudC5kYXRhKCd3b3JrZmxvdy1kZWZpbml0aW9uJyk7XHJcbiAgICAgICAgdmFyIGRlbGV0ZUFjdGl2aXR5UHJvbXB0OiBzdHJpbmcgPSAkZWxlbWVudC5kYXRhKCd3b3JrZmxvdy1kZWxldGUtYWN0aXZpdHktcHJvbXB0Jyk7XHJcbiAgICAgICAgdmFyIGxvY2FsSWQ6IHN0cmluZyA9ICRlbGVtZW50LmRhdGEoJ3dvcmtmbG93LWxvY2FsLWlkJyk7XHJcbiAgICAgICAgdmFyIGxvYWRMb2NhbFN0YXRlOiBib29sZWFuID0gJGVsZW1lbnQuZGF0YSgnd29ya2Zsb3ctbG9hZC1sb2NhbC1zdGF0ZScpO1xyXG5cclxuICAgICAgICB3b3JrZmxvd0RlZmluaXRpb24ucmVtb3ZlZEFjdGl2aXRpZXMgPSB3b3JrZmxvd0RlZmluaXRpb24ucmVtb3ZlZEFjdGl2aXRpZXMgfHwgW107XHJcbiAgICAgICAgJGVsZW1lbnQuZGF0YSgnd29ya2Zsb3dFZGl0b3InLCBuZXcgV29ya2Zsb3dFZGl0b3IoZWxlbWVudCwgd29ya2Zsb3dEZWZpbml0aW9uLCBkZWxldGVBY3Rpdml0eVByb21wdCwgbG9jYWxJZCwgbG9hZExvY2FsU3RhdGUpKTtcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiB0aGlzO1xyXG59O1xyXG5cclxuJChkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24gKCkge1xyXG4gICAgY29uc3Qgd29ya2Zsb3dFZGl0b3I6IFdvcmtmbG93RWRpdG9yID0gJCgnLndvcmtmbG93LWVkaXRvci1jYW52YXMnKS53b3JrZmxvd0VkaXRvcigpLmRhdGEoJ3dvcmtmbG93RWRpdG9yJyk7XHJcblxyXG4gICAgJCgnI3dvcmtmbG93RWRpdG9yRm9ybScpLm9uKCdzdWJtaXQnLCAocywgZSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHN0YXRlID0gd29ya2Zsb3dFZGl0b3Iuc2VyaWFsaXplKCk7XHJcbiAgICAgICAgJCgnI3dvcmtmbG93U3RhdGVJbnB1dCcpLnZhbChzdGF0ZSk7XHJcbiAgICB9KTtcclxufSk7Il19
