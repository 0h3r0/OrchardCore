/*
** NOTE: This file is generated by Gulp and should not be edited directly!
** Any changes made directly to this file will be overwritten next time its asset group is processed by Gulp.
*/

///<reference path='../Lib/jquery/typings.d.ts' />
///<reference path='../Lib/jsplumb/typings.d.ts' />
///<reference path='./workflow-models.ts' />
var WorkflowEditor = /** @class */ (function () {
    function WorkflowEditor(container, workflowDefinitionData) {
        var _this = this;
        this.container = container;
        this.serialize = function () {
            var allActivityElements = $(this.container).find('.activity');
            var workflow = {
                activities: [],
                transitions: []
            };
            // Collect activity positions.
            for (var i = 0; i < allActivityElements.length; i++) {
                var activityElementQuery = $(allActivityElements[i]);
                var activityId = activityElementQuery.data('activity-id');
                var activityPosition = activityElementQuery.position();
                workflow.activities.push({
                    id: activityId,
                    x: activityPosition.left,
                    y: activityPosition.top
                });
            }
            // Collect activity connections.
            var allConnections = this.jsPlumbInstance.getConnections();
            for (var i = 0; i < allConnections.length; i++) {
                var connection = allConnections[i];
                var sourceEndpoint = connection.endpoints[0];
                var sourceOutcomeName = sourceEndpoint.getParameters().outcome.name;
                var sourceActivityId = $(connection.source).data('activity-id');
                var destinationActivityId = $(connection.target).data('activity-id');
                workflow.transitions.push({
                    sourceActivityId: sourceActivityId,
                    destinationActivityId: destinationActivityId,
                    sourceOutcomeName: sourceOutcomeName
                });
            }
            return JSON.stringify(workflow);
        };
        jsPlumb.ready(function () {
            var plumber = jsPlumb.getInstance({
                DragOptions: { cursor: 'pointer', zIndex: 2000 },
                ConnectionOverlays: [
                    ['Arrow', {
                            location: 1,
                            visible: true,
                            width: 11,
                            length: 11
                        }],
                    ['Label', {
                            location: 0.5,
                            id: 'label',
                            cssClass: 'connection-label'
                        }]
                ],
                Container: container
            });
            var getSourceEndpointOptions = function (activity, outcome) {
                // The definition of source endpoints.
                return {
                    endpoint: 'Dot',
                    anchor: 'Continuous',
                    paintStyle: {
                        stroke: '#7AB02C',
                        fill: '#7AB02C',
                        radius: 7,
                        strokeWidth: 1
                    },
                    isSource: true,
                    connector: ['Flowchart', { stub: [40, 60], gap: 0, cornerRadius: 5, alwaysRespectStubs: true }],
                    connectorStyle: {
                        strokeWidth: 2,
                        stroke: '#999999',
                        joinstyle: 'round',
                        outlineStroke: 'white',
                        outlineWidth: 2
                    },
                    hoverPaintStyle: {
                        fill: '#216477',
                        stroke: '#216477'
                    },
                    connectorHoverStyle: {
                        strokeWidth: 3,
                        stroke: '#216477',
                        outlineWidth: 5,
                        outlineStroke: 'white'
                    },
                    dragOptions: {},
                    overlays: [
                        ['Label', {
                                location: [0.5, 1.5],
                                //label: outcome.displayName,
                                cssClass: 'endpointSourceLabel',
                                visible: true
                            }]
                    ],
                    uuid: activity.id + "-" + outcome.name,
                    parameters: {
                        outcome: outcome
                    }
                };
            };
            // Listen for new connections.
            plumber.bind('connection', function (connInfo, originalEvent) {
                var connection = connInfo.connection;
                var outcome = connection.getParameters().outcome;
                var label = connection.getOverlay('label');
                label.setLabel(outcome.displayName);
            });
            var activityElements = $(container).find('.activity');
            // Suspend drawing and initialize.
            plumber.batch(function () {
                var workflowModel = workflowDefinitionData;
                var workflowId = workflowModel.id;
                activityElements.each(function (index, activityElement) {
                    var activityElementQuery = $(activityElement);
                    var activityId = activityElementQuery.data('activity-id');
                    // Make the activity draggable.
                    plumber.draggable(activityElement, { grid: [10, 10], });
                    // Configure the activity as a target.
                    plumber.makeTarget(activityElement, {
                        dropOptions: { hoverClass: 'hover' },
                        anchor: 'Continuous',
                        endpoint: ['Blank', { radius: 8 }]
                    });
                    // Add source endpoints.
                    var activity = $.grep(workflowModel.activities, function (x) { return x.id == activityId; })[0];
                    var hasMultipleOutcomes = activity.outcomes.length > 1;
                    for (var _i = 0, _a = activity.outcomes; _i < _a.length; _i++) {
                        var outcome = _a[_i];
                        var sourceEndpointOptions = getSourceEndpointOptions(activity, outcome);
                        plumber.addEndpoint(activityElement, sourceEndpointOptions);
                    }
                });
                // Connect activities.
                for (var _i = 0, _a = workflowModel.transitions; _i < _a.length; _i++) {
                    var transitionModel = _a[_i];
                    var sourceEndpointUuid = transitionModel.sourceActivityId + "-" + transitionModel.sourceOutcomeName;
                    var sourceEndpoint = plumber.getEndpoint(sourceEndpointUuid);
                    var destinationElementId = "activity-" + workflowId + "-" + transitionModel.destinationActivityId;
                    plumber.connect({
                        source: sourceEndpoint,
                        target: destinationElementId
                    });
                }
                plumber.bind('contextmenu', function (component, originalEvent) {
                });
                plumber.bind('connectionDrag', function (connection) {
                    console.log('connection ' + connection.id + ' is being dragged. suspendedElement is ', connection.suspendedElement, ' of type ', connection.suspendedElementType);
                });
                plumber.bind('connectionDragStop', function (connection) {
                    console.log('connection ' + connection.id + ' was dragged');
                });
                plumber.bind('connectionMoved', function (params) {
                    console.log('connection ' + params.connection.id + ' was moved');
                });
            });
            // Initialize popovers.
            activityElements.popover({
                trigger: 'manual',
                html: true,
                content: function () {
                    var activityElement = $(this);
                    var content = activityElement.find('.activity-commands').clone().show();
                    return content.get(0);
                }
            });
            $(container).on('click', '.activity', function (e) {
                // if any other popovers are visible, hide them
                if (_this.isPopoverVisible) {
                    activityElements.popover('hide');
                }
                var sender = $(e.currentTarget);
                sender.popover('show');
                // handle clicking on the popover itself.
                $('.popover').off('click').on('click', function (e2) {
                    e2.stopPropagation();
                });
                e.stopPropagation();
                _this.isPopoverVisible = true;
            });
            $(container).on('dblclick', '.activity', function (e) {
                var sender = $(e.currentTarget);
                sender.find('.activity-edit-action').get(0).click();
            });
            // Hide all popovers when clicking anywhere but on an activity.
            $('body').on('click', function (e) {
                activityElements.popover('hide');
                _this.isPopoverVisible = false;
            });
            _this.jsPlumbInstance = plumber;
        });
    }
    return WorkflowEditor;
}());
$.fn.workflowEditor = function () {
    this.each(function (index, element) {
        var $element = $(element);
        var workflowDefinitionData = $element.data('workflow-definition');
        $element.data('workflowEditor', new WorkflowEditor(element, workflowDefinitionData));
    });
    return this;
};
$(document).ready(function () {
    var workflowEditor = $('.workflow-editor-canvas').workflowEditor().data('workflowEditor');
    $('#workflowEditorForm').on('submit', function (s, e) {
        var state = workflowEditor.serialize();
        $('#workflowStateInput').val(state);
    });
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFFLENBQUM7UUFDdkMsSUFBTSxLQUFLLEdBQUcsY0FBYyxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ3pDLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN4QyxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQyxDQUFDIiwiZmlsZSI6Im9yY2hhcmQud29ya2Zsb3dzLXdvcmtmbG93LWVkaXRvci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vLzxyZWZlcmVuY2UgcGF0aD0nLi4vTGliL2pxdWVyeS90eXBpbmdzLmQudHMnIC8+XHJcbi8vLzxyZWZlcmVuY2UgcGF0aD0nLi4vTGliL2pzcGx1bWIvdHlwaW5ncy5kLnRzJyAvPlxyXG4vLy88cmVmZXJlbmNlIHBhdGg9Jy4vd29ya2Zsb3ctbW9kZWxzLnRzJyAvPlxyXG5cclxuY2xhc3MgV29ya2Zsb3dFZGl0b3Ige1xyXG4gICAgcHJpdmF0ZSBpc1BvcG92ZXJWaXNpYmxlOiBib29sZWFuO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgY29udGFpbmVyOiBIVE1MRWxlbWVudCwgd29ya2Zsb3dEZWZpbml0aW9uRGF0YTogV29ya2Zsb3dzLldvcmtmbG93KSB7XHJcblxyXG4gICAgICAgIGpzUGx1bWIucmVhZHkoKCkgPT4ge1xyXG4gICAgICAgICAgICB2YXIgcGx1bWJlciA9IGpzUGx1bWIuZ2V0SW5zdGFuY2Uoe1xyXG4gICAgICAgICAgICAgICAgRHJhZ09wdGlvbnM6IHsgY3Vyc29yOiAncG9pbnRlcicsIHpJbmRleDogMjAwMCB9LFxyXG4gICAgICAgICAgICAgICAgQ29ubmVjdGlvbk92ZXJsYXlzOiBbXHJcbiAgICAgICAgICAgICAgICAgICAgWydBcnJvdycsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9jYXRpb246IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZpc2libGU6IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiAxMSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGVuZ3RoOiAxMVxyXG4gICAgICAgICAgICAgICAgICAgIH1dLFxyXG4gICAgICAgICAgICAgICAgICAgIFsnTGFiZWwnLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uOiAwLjUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiAnbGFiZWwnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjc3NDbGFzczogJ2Nvbm5lY3Rpb24tbGFiZWwnXHJcbiAgICAgICAgICAgICAgICAgICAgfV1cclxuICAgICAgICAgICAgICAgIF0sXHJcbiAgICAgICAgICAgICAgICBDb250YWluZXI6IGNvbnRhaW5lclxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHZhciBnZXRTb3VyY2VFbmRwb2ludE9wdGlvbnMgPSBmdW5jdGlvbiAoYWN0aXZpdHk6IFdvcmtmbG93cy5BY3Rpdml0eSwgb3V0Y29tZTogV29ya2Zsb3dzLk91dGNvbWUpOiBFbmRwb2ludE9wdGlvbnMge1xyXG4gICAgICAgICAgICAgICAgLy8gVGhlIGRlZmluaXRpb24gb2Ygc291cmNlIGVuZHBvaW50cy5cclxuICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgZW5kcG9pbnQ6ICdEb3QnLFxyXG4gICAgICAgICAgICAgICAgICAgIGFuY2hvcjogJ0NvbnRpbnVvdXMnLFxyXG4gICAgICAgICAgICAgICAgICAgIHBhaW50U3R5bGU6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3Ryb2tlOiAnIzdBQjAyQycsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGw6ICcjN0FCMDJDJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmFkaXVzOiA3LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdHJva2VXaWR0aDogMVxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgaXNTb3VyY2U6IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdG9yOiBbJ0Zsb3djaGFydCcsIHsgc3R1YjogWzQwLCA2MF0sIGdhcDogMCwgY29ybmVyUmFkaXVzOiA1LCBhbHdheXNSZXNwZWN0U3R1YnM6IHRydWUgfV0sXHJcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdG9yU3R5bGU6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3Ryb2tlV2lkdGg6IDIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0cm9rZTogJyM5OTk5OTknLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBqb2luc3R5bGU6ICdyb3VuZCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG91dGxpbmVTdHJva2U6ICd3aGl0ZScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG91dGxpbmVXaWR0aDogMlxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgaG92ZXJQYWludFN0eWxlOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGw6ICcjMjE2NDc3JyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3Ryb2tlOiAnIzIxNjQ3NydcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3RvckhvdmVyU3R5bGU6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3Ryb2tlV2lkdGg6IDMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0cm9rZTogJyMyMTY0NzcnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBvdXRsaW5lV2lkdGg6IDUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG91dGxpbmVTdHJva2U6ICd3aGl0ZSdcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIGRyYWdPcHRpb25zOiB7fSxcclxuICAgICAgICAgICAgICAgICAgICBvdmVybGF5czogW1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBbJ0xhYmVsJywge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYXRpb246IFswLjUsIDEuNV0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL2xhYmVsOiBvdXRjb21lLmRpc3BsYXlOYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY3NzQ2xhc3M6ICdlbmRwb2ludFNvdXJjZUxhYmVsJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpc2libGU6IHRydWVcclxuICAgICAgICAgICAgICAgICAgICAgICAgfV1cclxuICAgICAgICAgICAgICAgICAgICBdLFxyXG4gICAgICAgICAgICAgICAgICAgIHV1aWQ6IGAke2FjdGl2aXR5LmlkfS0ke291dGNvbWUubmFtZX1gLFxyXG4gICAgICAgICAgICAgICAgICAgIHBhcmFtZXRlcnM6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgb3V0Y29tZTogb3V0Y29tZVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAvLyBMaXN0ZW4gZm9yIG5ldyBjb25uZWN0aW9ucy5cclxuICAgICAgICAgICAgcGx1bWJlci5iaW5kKCdjb25uZWN0aW9uJywgZnVuY3Rpb24gKGNvbm5JbmZvLCBvcmlnaW5hbEV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjb25uZWN0aW9uOiBDb25uZWN0aW9uID0gY29ubkluZm8uY29ubmVjdGlvbjtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG91dGNvbWU6IFdvcmtmbG93cy5PdXRjb21lID0gY29ubmVjdGlvbi5nZXRQYXJhbWV0ZXJzKCkub3V0Y29tZTtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBsYWJlbDogYW55ID0gY29ubmVjdGlvbi5nZXRPdmVybGF5KCdsYWJlbCcpO1xyXG4gICAgICAgICAgICAgICAgbGFiZWwuc2V0TGFiZWwob3V0Y29tZS5kaXNwbGF5TmFtZSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgYWN0aXZpdHlFbGVtZW50cyA9ICQoY29udGFpbmVyKS5maW5kKCcuYWN0aXZpdHknKTtcclxuXHJcbiAgICAgICAgICAgIC8vIFN1c3BlbmQgZHJhd2luZyBhbmQgaW5pdGlhbGl6ZS5cclxuICAgICAgICAgICAgcGx1bWJlci5iYXRjaChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgd29ya2Zsb3dNb2RlbDogV29ya2Zsb3dzLldvcmtmbG93ID0gd29ya2Zsb3dEZWZpbml0aW9uRGF0YTtcclxuICAgICAgICAgICAgICAgIHZhciB3b3JrZmxvd0lkID0gd29ya2Zsb3dNb2RlbC5pZDtcclxuXHJcbiAgICAgICAgICAgICAgICBhY3Rpdml0eUVsZW1lbnRzLmVhY2goKGluZGV4LCBhY3Rpdml0eUVsZW1lbnQpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBhY3Rpdml0eUVsZW1lbnRRdWVyeSA9ICQoYWN0aXZpdHlFbGVtZW50KTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBhY3Rpdml0eUlkID0gYWN0aXZpdHlFbGVtZW50UXVlcnkuZGF0YSgnYWN0aXZpdHktaWQnKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gTWFrZSB0aGUgYWN0aXZpdHkgZHJhZ2dhYmxlLlxyXG4gICAgICAgICAgICAgICAgICAgIHBsdW1iZXIuZHJhZ2dhYmxlKGFjdGl2aXR5RWxlbWVudCwgeyBncmlkOiBbMTAsIDEwXSwgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIENvbmZpZ3VyZSB0aGUgYWN0aXZpdHkgYXMgYSB0YXJnZXQuXHJcbiAgICAgICAgICAgICAgICAgICAgcGx1bWJlci5tYWtlVGFyZ2V0KGFjdGl2aXR5RWxlbWVudCwge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkcm9wT3B0aW9uczogeyBob3ZlckNsYXNzOiAnaG92ZXInIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFuY2hvcjogJ0NvbnRpbnVvdXMnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbmRwb2ludDogWydCbGFuaycsIHsgcmFkaXVzOiA4IH1dXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIEFkZCBzb3VyY2UgZW5kcG9pbnRzLlxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGFjdGl2aXR5ID0gJC5ncmVwKHdvcmtmbG93TW9kZWwuYWN0aXZpdGllcywgKHg6IFdvcmtmbG93cy5BY3Rpdml0eSkgPT4geC5pZCA9PSBhY3Rpdml0eUlkKVswXTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBoYXNNdWx0aXBsZU91dGNvbWVzID0gYWN0aXZpdHkub3V0Y29tZXMubGVuZ3RoID4gMTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgb3V0Y29tZSBvZiBhY3Rpdml0eS5vdXRjb21lcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzb3VyY2VFbmRwb2ludE9wdGlvbnMgPSBnZXRTb3VyY2VFbmRwb2ludE9wdGlvbnMoYWN0aXZpdHksIG91dGNvbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwbHVtYmVyLmFkZEVuZHBvaW50KGFjdGl2aXR5RWxlbWVudCwgc291cmNlRW5kcG9pbnRPcHRpb25zKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyBDb25uZWN0IGFjdGl2aXRpZXMuXHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCB0cmFuc2l0aW9uTW9kZWwgb2Ygd29ya2Zsb3dNb2RlbC50cmFuc2l0aW9ucykge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNvdXJjZUVuZHBvaW50VXVpZDogc3RyaW5nID0gYCR7dHJhbnNpdGlvbk1vZGVsLnNvdXJjZUFjdGl2aXR5SWR9LSR7dHJhbnNpdGlvbk1vZGVsLnNvdXJjZU91dGNvbWVOYW1lfWA7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc291cmNlRW5kcG9pbnQ6IEVuZHBvaW50ID0gcGx1bWJlci5nZXRFbmRwb2ludChzb3VyY2VFbmRwb2ludFV1aWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRlc3RpbmF0aW9uRWxlbWVudElkOiBzdHJpbmcgPSBgYWN0aXZpdHktJHt3b3JrZmxvd0lkfS0ke3RyYW5zaXRpb25Nb2RlbC5kZXN0aW5hdGlvbkFjdGl2aXR5SWR9YDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcGx1bWJlci5jb25uZWN0KHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlOiBzb3VyY2VFbmRwb2ludCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiBkZXN0aW5hdGlvbkVsZW1lbnRJZFxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHBsdW1iZXIuYmluZCgnY29udGV4dG1lbnUnLCBmdW5jdGlvbiAoY29tcG9uZW50LCBvcmlnaW5hbEV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICBwbHVtYmVyLmJpbmQoJ2Nvbm5lY3Rpb25EcmFnJywgZnVuY3Rpb24gKGNvbm5lY3Rpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnY29ubmVjdGlvbiAnICsgY29ubmVjdGlvbi5pZCArICcgaXMgYmVpbmcgZHJhZ2dlZC4gc3VzcGVuZGVkRWxlbWVudCBpcyAnLCBjb25uZWN0aW9uLnN1c3BlbmRlZEVsZW1lbnQsICcgb2YgdHlwZSAnLCBjb25uZWN0aW9uLnN1c3BlbmRlZEVsZW1lbnRUeXBlKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIHBsdW1iZXIuYmluZCgnY29ubmVjdGlvbkRyYWdTdG9wJywgZnVuY3Rpb24gKGNvbm5lY3Rpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnY29ubmVjdGlvbiAnICsgY29ubmVjdGlvbi5pZCArICcgd2FzIGRyYWdnZWQnKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIHBsdW1iZXIuYmluZCgnY29ubmVjdGlvbk1vdmVkJywgZnVuY3Rpb24gKHBhcmFtcykge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdjb25uZWN0aW9uICcgKyBwYXJhbXMuY29ubmVjdGlvbi5pZCArICcgd2FzIG1vdmVkJyk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAvLyBJbml0aWFsaXplIHBvcG92ZXJzLlxyXG4gICAgICAgICAgICBhY3Rpdml0eUVsZW1lbnRzLnBvcG92ZXIoe1xyXG4gICAgICAgICAgICAgICAgdHJpZ2dlcjogJ21hbnVhbCcsXHJcbiAgICAgICAgICAgICAgICBodG1sOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgY29udGVudDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGFjdGl2aXR5RWxlbWVudCA9ICQodGhpcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29udGVudDogSlF1ZXJ5ID0gYWN0aXZpdHlFbGVtZW50LmZpbmQoJy5hY3Rpdml0eS1jb21tYW5kcycpLmNsb25lKCkuc2hvdygpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZW50LmdldCgwKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAkKGNvbnRhaW5lcikub24oJ2NsaWNrJywgJy5hY3Rpdml0eScsIGUgPT4ge1xyXG4gICAgICAgICAgICAgICAgLy8gaWYgYW55IG90aGVyIHBvcG92ZXJzIGFyZSB2aXNpYmxlLCBoaWRlIHRoZW1cclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzUG9wb3ZlclZpc2libGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBhY3Rpdml0eUVsZW1lbnRzLnBvcG92ZXIoJ2hpZGUnKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBzZW5kZXIgPSAkKGUuY3VycmVudFRhcmdldCk7XHJcbiAgICAgICAgICAgICAgICBzZW5kZXIucG9wb3Zlcignc2hvdycpO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIGhhbmRsZSBjbGlja2luZyBvbiB0aGUgcG9wb3ZlciBpdHNlbGYuXHJcbiAgICAgICAgICAgICAgICAkKCcucG9wb3ZlcicpLm9mZignY2xpY2snKS5vbignY2xpY2snLCBlMiA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgZTIuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG5cclxuICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmlzUG9wb3ZlclZpc2libGUgPSB0cnVlO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICQoY29udGFpbmVyKS5vbignZGJsY2xpY2snLCAnLmFjdGl2aXR5JywgZSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzZW5kZXIgPSAkKGUuY3VycmVudFRhcmdldCk7XHJcbiAgICAgICAgICAgICAgICBzZW5kZXIuZmluZCgnLmFjdGl2aXR5LWVkaXQtYWN0aW9uJykuZ2V0KDApLmNsaWNrKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgLy8gSGlkZSBhbGwgcG9wb3ZlcnMgd2hlbiBjbGlja2luZyBhbnl3aGVyZSBidXQgb24gYW4gYWN0aXZpdHkuXHJcbiAgICAgICAgICAgICQoJ2JvZHknKS5vbignY2xpY2snLCBlID0+IHtcclxuICAgICAgICAgICAgICAgIGFjdGl2aXR5RWxlbWVudHMucG9wb3ZlcignaGlkZScpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pc1BvcG92ZXJWaXNpYmxlID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5qc1BsdW1iSW5zdGFuY2UgPSBwbHVtYmVyO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUganNQbHVtYkluc3RhbmNlOiBqc1BsdW1iSW5zdGFuY2U7XHJcblxyXG4gICAgcHVibGljIHNlcmlhbGl6ZSA9IGZ1bmN0aW9uICgpOiBzdHJpbmcge1xyXG4gICAgICAgIGNvbnN0IGFsbEFjdGl2aXR5RWxlbWVudHMgPSAkKHRoaXMuY29udGFpbmVyKS5maW5kKCcuYWN0aXZpdHknKTtcclxuICAgICAgICBjb25zdCB3b3JrZmxvdzogYW55ID0ge1xyXG4gICAgICAgICAgICBhY3Rpdml0aWVzOiBbXSxcclxuICAgICAgICAgICAgdHJhbnNpdGlvbnM6IFtdXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgLy8gQ29sbGVjdCBhY3Rpdml0eSBwb3NpdGlvbnMuXHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhbGxBY3Rpdml0eUVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIHZhciBhY3Rpdml0eUVsZW1lbnRRdWVyeSA9ICQoYWxsQWN0aXZpdHlFbGVtZW50c1tpXSk7XHJcbiAgICAgICAgICAgIHZhciBhY3Rpdml0eUlkOiBudW1iZXIgPSBhY3Rpdml0eUVsZW1lbnRRdWVyeS5kYXRhKCdhY3Rpdml0eS1pZCcpO1xyXG4gICAgICAgICAgICB2YXIgYWN0aXZpdHlQb3NpdGlvbiA9IGFjdGl2aXR5RWxlbWVudFF1ZXJ5LnBvc2l0aW9uKCk7XHJcblxyXG4gICAgICAgICAgICB3b3JrZmxvdy5hY3Rpdml0aWVzLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgaWQ6IGFjdGl2aXR5SWQsXHJcbiAgICAgICAgICAgICAgICB4OiBhY3Rpdml0eVBvc2l0aW9uLmxlZnQsXHJcbiAgICAgICAgICAgICAgICB5OiBhY3Rpdml0eVBvc2l0aW9uLnRvcFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIENvbGxlY3QgYWN0aXZpdHkgY29ubmVjdGlvbnMuXHJcbiAgICAgICAgY29uc3QgYWxsQ29ubmVjdGlvbnMgPSB0aGlzLmpzUGx1bWJJbnN0YW5jZS5nZXRDb25uZWN0aW9ucygpO1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYWxsQ29ubmVjdGlvbnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgdmFyIGNvbm5lY3Rpb24gPSBhbGxDb25uZWN0aW9uc1tpXTtcclxuICAgICAgICAgICAgdmFyIHNvdXJjZUVuZHBvaW50OiBFbmRwb2ludCA9IGNvbm5lY3Rpb24uZW5kcG9pbnRzWzBdO1xyXG4gICAgICAgICAgICB2YXIgc291cmNlT3V0Y29tZU5hbWUgPSBzb3VyY2VFbmRwb2ludC5nZXRQYXJhbWV0ZXJzKCkub3V0Y29tZS5uYW1lO1xyXG4gICAgICAgICAgICB2YXIgc291cmNlQWN0aXZpdHlJZDogbnVtYmVyID0gJChjb25uZWN0aW9uLnNvdXJjZSkuZGF0YSgnYWN0aXZpdHktaWQnKTtcclxuICAgICAgICAgICAgdmFyIGRlc3RpbmF0aW9uQWN0aXZpdHlJZDogbnVtYmVyID0gJChjb25uZWN0aW9uLnRhcmdldCkuZGF0YSgnYWN0aXZpdHktaWQnKTtcclxuXHJcbiAgICAgICAgICAgIHdvcmtmbG93LnRyYW5zaXRpb25zLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgc291cmNlQWN0aXZpdHlJZDogc291cmNlQWN0aXZpdHlJZCxcclxuICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uQWN0aXZpdHlJZDogZGVzdGluYXRpb25BY3Rpdml0eUlkLFxyXG4gICAgICAgICAgICAgICAgc291cmNlT3V0Y29tZU5hbWU6IHNvdXJjZU91dGNvbWVOYW1lXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkod29ya2Zsb3cpO1xyXG4gICAgfVxyXG59XHJcblxyXG4kLmZuLndvcmtmbG93RWRpdG9yID0gZnVuY3Rpb24gKHRoaXM6IEpRdWVyeSk6IEpRdWVyeSB7XHJcbiAgICB0aGlzLmVhY2goKGluZGV4LCBlbGVtZW50KSA9PiB7XHJcbiAgICAgICAgdmFyICRlbGVtZW50ID0gJChlbGVtZW50KTtcclxuICAgICAgICB2YXIgd29ya2Zsb3dEZWZpbml0aW9uRGF0YTogV29ya2Zsb3dzLldvcmtmbG93ID0gJGVsZW1lbnQuZGF0YSgnd29ya2Zsb3ctZGVmaW5pdGlvbicpO1xyXG5cclxuICAgICAgICAkZWxlbWVudC5kYXRhKCd3b3JrZmxvd0VkaXRvcicsIG5ldyBXb3JrZmxvd0VkaXRvcihlbGVtZW50LCB3b3JrZmxvd0RlZmluaXRpb25EYXRhKSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gdGhpcztcclxufTtcclxuXHJcbiQoZG9jdW1lbnQpLnJlYWR5KGZ1bmN0aW9uICgpIHtcclxuICAgIGNvbnN0IHdvcmtmbG93RWRpdG9yOiBXb3JrZmxvd0VkaXRvciA9ICQoJy53b3JrZmxvdy1lZGl0b3ItY2FudmFzJykud29ya2Zsb3dFZGl0b3IoKS5kYXRhKCd3b3JrZmxvd0VkaXRvcicpO1xyXG5cclxuICAgICQoJyN3b3JrZmxvd0VkaXRvckZvcm0nKS5vbignc3VibWl0JywgKHMsIGUpID0+IHtcclxuICAgICAgICBjb25zdCBzdGF0ZSA9IHdvcmtmbG93RWRpdG9yLnNlcmlhbGl6ZSgpO1xyXG4gICAgICAgICQoJyN3b3JrZmxvd1N0YXRlSW5wdXQnKS52YWwoc3RhdGUpO1xyXG4gICAgfSk7XHJcbn0pOyJdfQ==
