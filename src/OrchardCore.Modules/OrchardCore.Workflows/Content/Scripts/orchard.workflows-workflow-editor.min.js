var WorkflowEditor=function(){return function(t,i,o,n,e){var a=this;this.container=t,this.workflowDefinition=i,this.deleteActivityPrompt=o,this.localId=n,this.getActivity=function(t,i){return void 0===i&&(i=null),i||(i=this.workflowDefinition.activities),$.grep(i,function(i){return i.id===t})[0]},this.getState=function(){for(var t=$(this.container).find(".activity"),i={id:this.workflowDefinition.id,activities:[],transitions:[]},o=0;o<t.length;o++){var n=$(t[o]),e=n.data("activity-id"),a=n.data("activity-start"),r=n.position(),c=this.getActivity(e);i.activities.push({id:e,isStart:a,outcomes:c.outcomes,x:r.left,y:r.top})}var s=this.jsPlumbInstance.getConnections();for(o=0;o<s.length;o++){var l=s[o],d=l.endpoints[0].getParameters().outcome.name,u=$(l.source).data("activity-id"),v=$(l.target).data("activity-id");i.transitions.push({sourceActivityId:u,destinationActivityId:v,sourceOutcomeName:d})}return i},this.serialize=function(){var t=this.getState();return JSON.stringify(t)},this.saveLocalState=function(){var t=this.getState();sessionStorage[this.localId]=this.serialize(t)},this.loadLocalState=function(){return JSON.parse(sessionStorage[this.localId])};var r=this;jsPlumb.ready(function(){jsPlumb.importDefaults({Anchor:"Continuous",DragOptions:{cursor:"pointer",zIndex:2e3},EndpointStyles:[{fillStyle:"#225588"}],Endpoints:[["Dot",{radius:7}],["Blank"]],ConnectionOverlays:[["Arrow",{width:12,length:12,location:-5}]],ConnectorZIndex:5});var i=jsPlumb.getInstance({DragOptions:{cursor:"pointer",zIndex:2e3},ConnectionOverlays:[["Arrow",{location:1,visible:!0,width:11,length:11}],["Label",{location:.5,id:"label",cssClass:"connection-label"}]],Container:t});i.bind("connection",function(t,i){var o=t.connection,n=o.getParameters().outcome;o.getOverlay("label").setLabel(n.displayName)});var o=$(t).find(".activity");i.batch(function(){var t=a.workflowDefinition,n=a.workflowDefinition.id;if(e){var r=a.loadLocalState();r&&(a.workflowDefinition=r)}o.each(function(o,n){var r=$(n),c=r.data("activity-id"),s=a.getActivity(c);e&&(null==s&&(s=a.getActivity(c,t.activities),a.workflowDefinition.activities.push(s),s.x=50,s.y=50),r.css({left:s.x,top:s.y}).toggleClass("activity-start",s.isStart).data("activity-start",s.isStart)),i.draggable(n,{grid:[10,10]}),i.makeTarget(n,{dropOptions:{hoverClass:"hover"},anchor:"Continuous",endpoint:["Blank",{radius:8}]});for(var l=0,d=s.outcomes;l<d.length;l++){var u=d[l],v=(f=s,p=u,{endpoint:"Dot",anchor:"Continuous",paintStyle:{stroke:"#7AB02C",fill:"#7AB02C",radius:7,strokeWidth:1},isSource:!0,connector:["Flowchart",{stub:[40,60],gap:0,cornerRadius:5,alwaysRespectStubs:!0}],connectorStyle:{strokeWidth:2,stroke:"#999999",joinstyle:"round",outlineStroke:"white",outlineWidth:2},hoverPaintStyle:{fill:"#216477",stroke:"#216477"},connectorHoverStyle:{strokeWidth:3,stroke:"#216477",outlineWidth:5,outlineStroke:"white"},connectorOverlays:[["Label",{location:[3,-1.5],cssClass:"endpointSourceLabel"}]],dragOptions:{},uuid:f.id+"-"+p.name,parameters:{outcome:p}});i.addEndpoint(n,{connectorOverlays:[["Label",{label:u.displayName,cssClass:"connection-label"}]]},v)}var f,p});for(var c=0,s=a.workflowDefinition.transitions;c<s.length;c++){var l=s[c],d=l.sourceActivityId+"-"+l.sourceOutcomeName,u=i.getEndpoint(d),v="activity-"+n+"-"+l.destinationActivityId;i.connect({source:u,target:v})}i.bind("contextmenu",function(t,i){}),i.bind("connectionDrag",function(t){console.log("connection "+t.id+" is being dragged. suspendedElement is ",t.suspendedElement," of type ",t.suspendedElementType)}),i.bind("connectionDragStop",function(t){console.log("connection "+t.id+" was dragged")}),i.bind("connectionMoved",function(t){console.log("connection "+t.connection.id+" was moved")})}),o.popover({trigger:"manual",html:!0,content:function(){var t=$(this),o=t.find(".activity-commands").clone().show(),n=o.find(".activity-start-action"),e=!0===t.data("activity-start");return n.attr("aria-pressed",t.data("activity-start")),n.toggleClass("active",e),o.on("click",".activity-start-action",function(i){i.preventDefault();var o=$(i.currentTarget);o.button("toggle");var n=o.is(".active");t.data("activity-start",n),t.toggleClass("activity-start",n)}),o.on("click",".activity-delete-action",function(o){o.preventDefault(),confirm(r.deleteActivityPrompt)&&(i.remove(t),t.popover("dispose"))}),o.on("click","[data-persist-workflow]",function(t){r.saveLocalState()}),o.get(0)}}),$(t).on("click",".activity",function(t){a.isDragging||(a.isPopoverVisible&&o.popover("hide"),$(t.currentTarget).popover("show"),$(".popover").off("click").on("click",function(t){t.stopPropagation()}),t.stopPropagation(),a.isPopoverVisible=!0)}),$(t).on("dblclick",".activity",function(t){var i=$(t.currentTarget);a.saveLocalState(),i.find(".activity-edit-action").get(0).click()}),$("body").on("click",function(t){o.popover("hide"),a.isPopoverVisible=!1}),$("body").on("click","[data-persist-workflow]",function(t){a.saveLocalState()}),a.jsPlumbInstance=i})}}();$.fn.workflowEditor=function(){return this.each(function(t,i){var o=$(i),n=o.data("workflow-definition"),e=o.data("workflow-delete-activity-prompt"),a=o.data("workflow-local-id"),r=o.data("workflow-load-local-state");o.data("workflowEditor",new WorkflowEditor(i,n,e,a,r))}),this},$(document).ready(function(){var t=$(".workflow-editor-canvas").workflowEditor().data("workflowEditor");$("#workflowEditorForm").on("submit",function(i,o){var n=t.serialize();$("#workflowStateInput").val(n)})});
