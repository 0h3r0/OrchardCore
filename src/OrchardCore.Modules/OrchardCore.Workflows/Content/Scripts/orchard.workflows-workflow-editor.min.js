var WorkflowEditor=function(){return function(t,o){var n=this;this.container=t,this.serialize=function(){for(var t=$(this.container).find(".activity"),o={activities:[],transitions:[]},n=0;n<t.length;n++){var i=$(t[n]),e=i.data("activity-id"),r=i.position();o.activities.push({id:e,x:r.left,y:r.top})}var a=this.jsPlumbInstance.getConnections();for(n=0;n<a.length;n++){var c=a[n],s=c.endpoints[0].getParameters().outcome.name,d=$(c.source).data("activity-id"),l=$(c.target).data("activity-id");o.transitions.push({sourceActivityId:d,destinationActivityId:l,sourceOutcomeName:s})}return JSON.stringify(o)},jsPlumb.ready(function(){var i=jsPlumb.getInstance({DragOptions:{cursor:"pointer",zIndex:2e3},ConnectionOverlays:[["Arrow",{location:1,visible:!0,width:11,length:11}],["Label",{location:.5,id:"label",cssClass:"connection-label"}]],Container:t}),e=function(t,o){return{endpoint:"Dot",anchor:"Continuous",paintStyle:{stroke:"#7AB02C",fill:"#7AB02C",radius:7,strokeWidth:1},isSource:!0,connector:["Flowchart",{stub:[40,60],gap:0,cornerRadius:5,alwaysRespectStubs:!0}],connectorStyle:{strokeWidth:2,stroke:"#999999",joinstyle:"round",outlineStroke:"white",outlineWidth:2},hoverPaintStyle:{fill:"#216477",stroke:"#216477"},connectorHoverStyle:{strokeWidth:3,stroke:"#216477",outlineWidth:5,outlineStroke:"white"},dragOptions:{},overlays:[["Label",{location:[.5,1.5],cssClass:"endpointSourceLabel",visible:!0}]],uuid:t.id+"-"+o.name,parameters:{outcome:o}}};i.bind("connection",function(t,o){var n=t.connection,i=n.getParameters().outcome;n.getOverlay("label").setLabel(i.displayName)});var r=$(t).find(".activity");i.batch(function(){var t=o,n=t.id;r.each(function(o,n){var r=$(n).data("activity-id");i.draggable(n,{grid:[10,10]}),i.makeTarget(n,{dropOptions:{hoverClass:"hover"},anchor:"Continuous",endpoint:["Blank",{radius:8}]});for(var a=$.grep(t.activities,function(t){return t.id==r})[0],c=(a.outcomes.length,0),s=a.outcomes;c<s.length;c++){var d=s[c],l=e(a,d);i.addEndpoint(n,l)}});for(var a=0,c=t.transitions;a<c.length;a++){var s=c[a],d=s.sourceActivityId+"-"+s.sourceOutcomeName,l=i.getEndpoint(d),u="activity-"+n+"-"+s.destinationActivityId;i.connect({source:l,target:u})}i.bind("contextmenu",function(t,o){}),i.bind("connectionDrag",function(t){console.log("connection "+t.id+" is being dragged. suspendedElement is ",t.suspendedElement," of type ",t.suspendedElementType)}),i.bind("connectionDragStop",function(t){console.log("connection "+t.id+" was dragged")}),i.bind("connectionMoved",function(t){console.log("connection "+t.connection.id+" was moved")})}),r.popover({trigger:"manual",html:!0,content:function(){return $(this).find(".activity-commands").clone().show().get(0)}}),$(t).on("click",".activity",function(t){n.isPopoverVisible&&r.popover("hide"),$(t.currentTarget).popover("show"),$(".popover").off("click").on("click",function(t){t.stopPropagation()}),t.stopPropagation(),n.isPopoverVisible=!0}),$(t).on("dblclick",".activity",function(t){$(t.currentTarget).find(".activity-edit-action").get(0).click()}),$("body").on("click",function(t){r.popover("hide"),n.isPopoverVisible=!1}),n.jsPlumbInstance=i})}}();$.fn.workflowEditor=function(){return this.each(function(t,o){var n=$(o),i=n.data("workflow-definition");n.data("workflowEditor",new WorkflowEditor(o,i))}),this},$(document).ready(function(){var t=$(".workflow-editor-canvas").workflowEditor().data("workflowEditor");$("#workflowEditorForm").on("submit",function(o,n){var i=t.serialize();$("#workflowStateInput").val(i)})});
