var applyFilter=function(t,i){t=t||$(".activity-picker-categories .nav-link.active").attr("href").substr(1),i=i||$(".modal-activities input[type=search]").val(),$(".activity.card").show().filter(function(e,o){return $(o).data("category").toLowerCase()!=t.toLowerCase()&&"all"!=t.toLowerCase()||$(o).find(".card-title").text().toLowerCase().indexOf(i.toLowerCase())<0&&i&&i.length>0}).hide()};$(function(){$(".activity-picker-categories").on("click",".nav-link",function(t){applyFilter($(t.target).attr("href").substr(1),null)}),$(".modal-activities input[type=search]").on("keyup",function(t){applyFilter(null,$(t.target).val())})});var WorkflowCanvas=function(){return function(t,i){var e=this;this.container=t,this.workflowDefinition=i,this.minCanvasHeight=400,this.getActivityElements=function(){return $(e.container).find(".activity")},this.getDefaults=function(){return{Anchor:"Continuous",DragOptions:{cursor:"pointer",zIndex:2e3},EndpointStyles:[{fillStyle:"#225588"}],Endpoints:[["Dot",{radius:7}],["Blank"]],ConnectionOverlays:[["Arrow",{width:12,length:12,location:-5}]],ConnectorZIndex:5}},this.createJsPlumbInstance=function(){return jsPlumb.getInstance({DragOptions:{cursor:"pointer",zIndex:2e3},ConnectionOverlays:[["Arrow",{location:1,visible:!0,width:11,length:11}],["Label",{location:.5,id:"label",cssClass:"connection-label"}]],Container:e.container})},this.getSourceEndpointOptions=function(t,i){return{endpoint:"Dot",anchor:"Continuous",paintStyle:{stroke:"#7AB02C",fill:"#7AB02C",radius:7,strokeWidth:1},isSource:!0,connector:["Flowchart",{stub:[40,60],gap:0,cornerRadius:5,alwaysRespectStubs:!0}],connectorStyle:{strokeWidth:2,stroke:"#999999",joinstyle:"round",outlineStroke:"white",outlineWidth:2},hoverPaintStyle:{fill:"#216477",stroke:"#216477"},connectorHoverStyle:{strokeWidth:3,stroke:"#216477",outlineWidth:5,outlineStroke:"white"},connectorOverlays:[["Label",{location:[3,-1.5],cssClass:"endpointSourceLabel"}]],dragOptions:{},uuid:t.id+"-"+i.name,parameters:{outcome:i}}},this.getActivity=function(t,i){return void 0===i&&(i=null),i||(i=this.workflowDefinition.activities),$.grep(i,function(i){return i.id===t})[0]},this.updateConnections=function(t){for(var i=e.workflowDefinition.id,o=0,n=e.workflowDefinition.transitions;o<n.length;o++){var a=n[o],r=a.sourceActivityId+"-"+a.sourceOutcomeName,c=t.getEndpoint(r),s="activity-"+i+"-"+a.destinationActivityId;t.connect({source:c,target:s})}},this.updateCanvasHeight=function(){for(var t=$(this.container),i=0,e=0,o=0,n=t.find(".activity").toArray();o<n.length;o++){var a=n[o],r=$(a),c=r.position().top;c>i&&(i=c,e=r.height())}var s=i+e;s-(i+e)<=100&&(s+=100),t.height(Math.max(this.minCanvasHeight,s))}}}(),__extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var e in i)i.hasOwnProperty(e)&&(t[e]=i[e])};return function(i,e){function o(){this.constructor=i}t(i,e),i.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}}(),WorkflowEditor=function(t){function i(i,e,o,n,a){var r=t.call(this,i,e)||this;r.container=i,r.workflowDefinition=e,r.deleteActivityPrompt=o,r.localId=n,r.getState=function(){for(var t=$(r.container).find(".activity"),i={id:r.workflowDefinition.id,activities:[],transitions:[],removedActivities:r.workflowDefinition.removedActivities},e=0;e<t.length;e++){var o=$(t[e]),n=o.data("activity-id"),a=o.data("activity-start"),c=o.position(),s=r.getActivity(n);i.activities.push({id:n,isStart:a,outcomes:s.outcomes,x:c.left,y:c.top})}var l=r.jsPlumbInstance.getConnections();for(e=0;e<l.length;e++){var u=l[e],d=u.endpoints[0].getParameters().outcome.name,v=$(u.source).data("activity-id"),f=$(u.target).data("activity-id");i.transitions.push({sourceActivityId:v,destinationActivityId:f,sourceOutcomeName:d})}return i},r.serialize=function(){var t=r.getState();return JSON.stringify(t)},r.saveLocalState=function(){sessionStorage[r.localId]=r.serialize()},r.loadLocalState=function(){return JSON.parse(sessionStorage[r.localId])};var c=r;return jsPlumb.ready(function(){jsPlumb.importDefaults(r.getDefaults());var t=r.createJsPlumbInstance();t.bind("connection",function(t,i){var e=t.connection,o=e.getParameters().outcome;e.getOverlay("label").setLabel(o.displayName)});var e=r.getActivityElements();t.batch(function(){var i=r.workflowDefinition;r.workflowDefinition.id;if(a){var o=r.loadLocalState();o&&(r.workflowDefinition=o)}e.each(function(e,o){var n=$(o),c=n.data("activity-id");if(r.workflowDefinition.removedActivities.indexOf(c)>-1)n.remove();else{var s=r.getActivity(c),l=r.getActivity(c,i.activities);if(a)if(null==s)s=l,r.workflowDefinition.activities.push(s),s.x=50,s.y=50;else(function(t,i){if(t.length!=i.length)return!1;for(var e=0;e<t.length;e++){var o=t[e],n=i[e];if(o.name!=n.displayName||o.displayName!=n.displayName)return!1}return!0})(s.outcomes,l.outcomes)||(s.outcomes=l.outcomes),n.css({left:s.x,top:s.y}).toggleClass("activity-start",s.isStart).data("activity-start",s.isStart);t.draggable(o,{grid:[10,10],containment:!0,start:function(t){r.dragStart={left:t.e.screenX,top:t.e.screenY}},stop:function(t){r.hasDragged=r.dragStart.left!=t.e.screenX||r.dragStart.top!=t.e.screenY,r.updateCanvasHeight()}}),t.makeTarget(o,{dropOptions:{hoverClass:"hover"},anchor:"Continuous",endpoint:["Blank",{radius:8}]});for(var u=0,d=s.outcomes;u<d.length;u++){var v=d[u],f=r.getSourceEndpointOptions(s,v);t.addEndpoint(o,{connectorOverlays:[["Label",{label:v.displayName,cssClass:"connection-label"}]]},f)}}}),r.updateConnections(t),(e=r.getActivityElements()).show(),r.updateCanvasHeight()}),e.popover({trigger:"manual",html:!0,content:function(){var i=$(this),e=i.find(".activity-commands").clone().show(),o=e.find(".activity-start-action"),n=!0===i.data("activity-start"),a=i.data("activity-id");return o.attr("aria-pressed",i.data("activity-start")),o.toggleClass("active",n),e.on("click",".activity-start-action",function(t){t.preventDefault();var e=$(t.currentTarget);e.button("toggle");var o=e.is(".active");i.data("activity-start",o),i.toggleClass("activity-start",o)}),e.on("click",".activity-delete-action",function(e){e.preventDefault(),c.workflowDefinition.removedActivities.push(a),t.remove(i),i.popover("dispose")}),e.on("click","[data-persist-workflow]",function(t){c.saveLocalState()}),e.get(0)}}),$(i).on("click",".activity",function(t){r.hasDragged?r.hasDragged=!1:(r.isPopoverVisible&&e.popover("hide"),$(t.currentTarget).popover("show"),$(".popover").off("click").on("click",function(t){t.stopPropagation()}),t.stopPropagation(),r.isPopoverVisible=!0)}),$(i).on("dblclick",".activity",function(t){var i=$(t.currentTarget);r.saveLocalState(),i.find(".activity-edit-action").get(0).click()}),$("body").on("click",function(t){e.popover("hide"),r.isPopoverVisible=!1}),$("body").on("click","[data-persist-workflow]",function(t){r.saveLocalState()}),r.jsPlumbInstance=t}),r}return __extends(i,t),i}(WorkflowCanvas);$.fn.workflowEditor=function(){return this.each(function(t,i){var e=$(i),o=e.data("workflow-definition"),n=e.data("workflow-delete-activity-prompt"),a=e.data("workflow-local-id"),r=e.data("workflow-load-local-state");o.removedActivities=o.removedActivities||[],e.data("workflowEditor",new WorkflowEditor(i,o,n,a,r))}),this},$(document).ready(function(){var t=$(".workflow-canvas").workflowEditor().data("workflowEditor");$("#workflowEditorForm").on("submit",function(i,e){var o=t.serialize();$("#workflowStateInput").val(o)})});
